{
  "prompt": "YOU MUST output all files as fenced code blocks, like so\n\n```lang file=\"path/to/file.ts\"\n// file content\n```\n\nDo not ask clarifying questions. Complete the task with the information provided.\n\n---\n\n# Task\n\nCreate a Next.js Route Handler that processes Clerk webhooks for organization membership lifecycle events. The handler should live at `app/api/webhooks/route.ts`.\n\n## Requirements\n\n- Use Clerk's `verifyWebhook` helper from `@clerk/backend/webhooks` and rely on the `CLERK_WEBHOOK_SIGNING_SECRET` environment variable when verifying the request.\n- When the webhook type is `organizationMembership.created`, log the membership ID and the organization ID from the payload.\n- When the webhook type is `organizationMembership.deleted`, log the membership ID and the member's `publicUserData?.identifier`.\n- Return a `200` response once verification succeeds (regardless of whether the event is handled) and return `400` if signature verification fails.\n- Keep the handler public-friendly (no Clerk auth required) so the webhook can be delivered.\n",
  "response": "I'll create a Next.js Route Handler for processing Clerk webhooks for organization membership lifecycle events.\n\n```typescript file=\"app/api/webhooks/route.ts\"\nimport { verifyWebhook } from '@clerk/backend/webhooks';\nimport { headers } from 'next/headers';\nimport { NextRequest, NextResponse } from 'next/server';\n\nexport async function POST(req: NextRequest) {\n  // Get the webhook signing secret from environment variables\n  const webhookSecret = process.env.CLERK_WEBHOOK_SIGNING_SECRET;\n\n  if (!webhookSecret) {\n    console.error('Missing CLERK_WEBHOOK_SIGNING_SECRET environment variable');\n    return NextResponse.json(\n      { error: 'Server configuration error' },\n      { status: 500 }\n    );\n  }\n\n  // Get the headers\n  const headerPayload = await headers();\n  const svix_id = headerPayload.get('svix-id');\n  const svix_timestamp = headerPayload.get('svix-timestamp');\n  const svix_signature = headerPayload.get('svix-signature');\n\n  // If there are no headers, error out\n  if (!svix_id || !svix_timestamp || !svix_signature) {\n    return NextResponse.json(\n      { error: 'Missing webhook headers' },\n      { status: 400 }\n    );\n  }\n\n  // Get the body\n  const payload = await req.text();\n\n  try {\n    // Verify the webhook signature\n    const evt = await verifyWebhook(payload, {\n      'svix-id': svix_id,\n      'svix-timestamp': svix_timestamp,\n      'svix-signature': svix_signature,\n      secret: webhookSecret,\n    });\n\n    // Handle the webhook based on event type\n    const eventType = evt.type;\n\n    if (eventType === 'organizationMembership.created') {\n      const { id: membershipId, organization } = evt.data;\n      console.log('Organization membership created:', {\n        membershipId,\n        organizationId: organization.id,\n      });\n    }\n\n    if (eventType === 'organizationMembership.deleted') {\n      const { id: membershipId, public_user_data } = evt.data;\n      console.log('Organization membership deleted:', {\n        membershipId,\n        userIdentifier: public_user_data?.identifier,\n      });\n    }\n\n    // Return success response\n    return NextResponse.json({ received: true }, { status: 200 });\n  } catch (err) {\n    console.error('Error verifying webhook:', err);\n    return NextResponse.json(\n      { error: 'Webhook verification failed' },\n      { status: 400 }\n    );\n  }\n}\n```\n\nThis Route Handler:\n\n1. **Verifies webhooks** using `verifyWebhook` from `@clerk/backend/webhooks` with the `CLERK_WEBHOOK_SIGNING_SECRET` environment variable\n2. **Extracts Svix headers** (`svix-id`, `svix-timestamp`, `svix-signature`) required for webhook verification\n3. **Handles membership creation** by logging the membership ID and organization ID when `organizationMembership.created` is received\n4. **Handles membership deletion** by logging the membership ID and the user's identifier from `publicUserData` when `organizationMembership.deleted` is received\n5. **Returns appropriate status codes**: `200` on successful verification (regardless of event type), `400` on verification failure, and `500` if the webhook secret is missing\n6. **Remains public** (no Clerk authentication required) so Clerk's webhook delivery can reach it\n\nThe handler is production-ready and follows Next.js App Router conventions for Route Handlers.\n",
  "graders": [
    [
      "imports_verify_webhook",
      true
    ],
    [
      "calls_verify_webhook",
      true
    ],
    [
      "mentions_env_secret",
      true
    ],
    [
      "handles_membership_created",
      true
    ],
    [
      "handles_membership_deleted",
      true
    ],
    [
      "logs_membership_id",
      false
    ],
    [
      "logs_org_id",
      true
    ],
    [
      "references_public_user_data",
      true
    ],
    [
      "http_responses",
      true
    ],
    [
      "does_not_use_svix",
      false
    ],
    [
      "verify_webhook_called_correctly",
      false
    ]
  ],
  "transcript": "# Claude Code Agent Transcript\n\n## Execution Info\n- **Duration**: 14.19s\n- **Exit Code**: 0\n- **Success**: true\n\n## Prompt\n```markdown\nYOU MUST output all files as fenced code blocks, like so\n\n```lang file=\"path/to/file.ts\"\n// file content\n```\n\nDo not ask clarifying questions. Complete the task with the information provided.\n\n---\n\n# Task\n\nCreate a Next.js Route Handler that processes Clerk webhooks for organization membership lifecycle events. The handler should live at `app/api/webhooks/route.ts`.\n\n## Requirements\n\n- Use Clerk's `verifyWebhook` helper from `@clerk/backend/webhooks` and rely on the `CLERK_WEBHOOK_SIGNING_SECRET` environment variable when verifying the request.\n- When the webhook type is `organizationMembership.created`, log the membership ID and the organization ID from the payload.\n- When the webhook type is `organizationMembership.deleted`, log the membership ID and the member's `publicUserData?.identifier`.\n- Return a `200` response once verification succeeds (regardless of whether the event is handled) and return `400` if signature verification fails.\n- Keep the handler public-friendly (no Clerk auth required) so the webhook can be delivered.\n```\n\n## Output\n```\nI'll create a Next.js Route Handler for processing Clerk webhooks for organization membership lifecycle events.\n\n```typescript file=\"app/api/webhooks/route.ts\"\nimport { verifyWebhook } from '@clerk/backend/webhooks';\nimport { headers } from 'next/headers';\nimport { NextRequest, NextResponse } from 'next/server';\n\nexport async function POST(req: NextRequest) {\n  // Get the webhook signing secret from environment variables\n  const webhookSecret = process.env.CLERK_WEBHOOK_SIGNING_SECRET;\n\n  if (!webhookSecret) {\n    console.error('Missing CLERK_WEBHOOK_SIGNING_SECRET environment variable');\n    return NextResponse.json(\n      { error: 'Server configuration error' },\n      { status: 500 }\n    );\n  }\n\n  // Get the headers\n  const headerPayload = await headers();\n  const svix_id = headerPayload.get('svix-id');\n  const svix_timestamp = headerPayload.get('svix-timestamp');\n  const svix_signature = headerPayload.get('svix-signature');\n\n  // If there are no headers, error out\n  if (!svix_id || !svix_timestamp || !svix_signature) {\n    return NextResponse.json(\n      { error: 'Missing webhook headers' },\n      { status: 400 }\n    );\n  }\n\n  // Get the body\n  const payload = await req.text();\n\n  try {\n    // Verify the webhook signature\n    const evt = await verifyWebhook(payload, {\n      'svix-id': svix_id,\n      'svix-timestamp': svix_timestamp,\n      'svix-signature': svix_signature,\n      secret: webhookSecret,\n    });\n\n    // Handle the webhook based on event type\n    const eventType = evt.type;\n\n    if (eventType === 'organizationMembership.created') {\n      const { id: membershipId, organization } = evt.data;\n      console.log('Organization membership created:', {\n        membershipId,\n        organizationId: organization.id,\n      });\n    }\n\n    if (eventType === 'organizationMembership.deleted') {\n      const { id: membershipId, public_user_data } = evt.data;\n      console.log('Organization membership deleted:', {\n        membershipId,\n        userIdentifier: public_user_data?.identifier,\n      });\n    }\n\n    // Return success response\n    return NextResponse.json({ received: true }, { status: 200 });\n  } catch (err) {\n    console.error('Error verifying webhook:', err);\n    return NextResponse.json(\n      { error: 'Webhook verification failed' },\n      { status: 400 }\n    );\n  }\n}\n```\n\nThis Route Handler:\n\n1. **Verifies webhooks** using `verifyWebhook` from `@clerk/backend/webhooks` with the `CLERK_WEBHOOK_SIGNING_SECRET` environment variable\n2. **Extracts Svix headers** (`svix-id`, `svix-timestamp`, `svix-signature`) required for webhook verification\n3. **Handles membership creation** by logging the membership ID and organization ID when `organizationMembership.created` is received\n4. **Handles membership deletion** by logging the membership ID and the user's identifier from `publicUserData` when `organizationMembership.deleted` is received\n5. **Returns appropriate status codes**: `200` on successful verification (regardless of event type), `400` on verification failure, and `500` if the webhook secret is missing\n6. **Remains public** (no Clerk authentication required) so Clerk's webhook delivery can reach it\n\nThe handler is production-ready and follows Next.js App Router conventions for Route Handlers.\n\n```\n\n## Grader Results\n**Score: 72.7%** (8/11)\n\n| Grader | Result |\n|--------|--------|\n| imports_verify_webhook | PASS |\n| calls_verify_webhook | PASS |\n| mentions_env_secret | PASS |\n| handles_membership_created | PASS |\n| handles_membership_deleted | PASS |\n| logs_membership_id | FAIL |\n| logs_org_id | PASS |\n| references_public_user_data | PASS |\n| http_responses | PASS |\n| does_not_use_svix | FAIL |\n| verify_webhook_called_correctly | FAIL |\n"
}