{
  "prompt": "YOU MUST output all files as fenced code blocks, like so\n\n```lang file=\"path/to/file.ts\"\n// file content\n```\n\nDo not ask clarifying questions. Complete the task with the information provided.\n\n---\n\nCreate a Next.js app with Clerk authentication. The application should sync the Clerk Organization slug with the URL.\n\nFor example, a B2B application named \"Petstore\" has two customer organizations: Acmecorp and Widgetco. Each organization uses its name as a slug in the URL:\n\nAcmecorp: https://petstore.example.com/orgs/acmecorp/dashboard\nWidgetco: https://petstore.example.com/orgs/widgetco/dashboard\n",
  "response": "I'll create a Next.js app with Clerk authentication that syncs the organization slug with the URL. This will be a B2B multi-tenant application structure.\n\n```typescript file=\"package.json\"\n{\n  \"name\": \"clerk-org-slug-sync\",\n  \"version\": \"0.1.0\",\n  \"private\": true,\n  \"scripts\": {\n    \"dev\": \"next dev\",\n    \"build\": \"next build\",\n    \"start\": \"next start\",\n    \"lint\": \"next lint\"\n  },\n  \"dependencies\": {\n    \"@clerk/nextjs\": \"^6.14.7\",\n    \"next\": \"15.1.6\",\n    \"react\": \"^19.0.0\",\n    \"react-dom\": \"^19.0.0\"\n  },\n  \"devDependencies\": {\n    \"@types/node\": \"^20\",\n    \"@types/react\": \"^19\",\n    \"@types/react-dom\": \"^19\",\n    \"eslint\": \"^8\",\n    \"eslint-config-next\": \"15.1.6\",\n    \"typescript\": \"^5\"\n  }\n}\n```\n\n```typescript file=\".env.local\"\nNEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=your_publishable_key_here\nCLERK_SECRET_KEY=your_secret_key_here\nNEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in\nNEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up\n```\n\n```typescript file=\"middleware.ts\"\nimport { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server';\nimport { NextResponse } from 'next/server';\n\nconst isPublicRoute = createRouteMatcher([\n  '/sign-in(.*)',\n  '/sign-up(.*)',\n  '/',\n]);\n\nconst isOrgRoute = createRouteMatcher(['/orgs/:slug(.*)']);\n\nexport default clerkMiddleware(async (auth, req) => {\n  const { userId, orgSlug, redirectToSignIn } = await auth();\n\n  // Allow public routes\n  if (isPublicRoute(req)) {\n    return NextResponse.next();\n  }\n\n  // Redirect to sign-in if not authenticated\n  if (!userId) {\n    return redirectToSignIn();\n  }\n\n  // Handle organization routes\n  if (isOrgRoute(req)) {\n    const url = new URL(req.url);\n    const pathSegments = url.pathname.split('/');\n    const urlSlug = pathSegments[2]; // /orgs/[slug]/...\n\n    // If user is in an org but URL doesn't match, redirect to correct org URL\n    if (orgSlug && urlSlug !== orgSlug) {\n      const newPath = url.pathname.replace(`/orgs/${urlSlug}`, `/orgs/${orgSlug}`);\n      return NextResponse.redirect(new URL(newPath, req.url));\n    }\n\n    // If URL has a slug but user isn't in that org, redirect to org selection\n    if (!orgSlug && urlSlug) {\n      return NextResponse.redirect(new URL('/select-org', req.url));\n    }\n  }\n\n  // If authenticated but not in org route and has org, redirect to org dashboard\n  if (userId && orgSlug && !isOrgRoute(req) && req.nextUrl.pathname !== '/select-org') {\n    return NextResponse.redirect(new URL(`/orgs/${orgSlug}/dashboard`, req.url));\n  }\n\n  // If authenticated but no org, redirect to org selection\n  if (userId && !orgSlug && !isOrgRoute(req) && req.nextUrl.pathname !== '/select-org') {\n    return NextResponse.redirect(new URL('/select-org', req.url));\n  }\n\n  return NextResponse.next();\n});\n\nexport const config = {\n  matcher: [\n    '/((?!_next|[^?]*\\\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',\n    '/(api|trpc)(.*)',\n  ],\n};\n```\n\n```typescript file=\"app/layout.tsx\"\nimport { ClerkProvider } from '@clerk/nextjs';\nimport type { Metadata } from 'next';\nimport './globals.css';\n\nexport const metadata: Metadata = {\n  title: 'Petstore - B2B Application',\n  description: 'Multi-tenant B2B application with Clerk organization management',\n};\n\nexport default function RootLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  return (\n    <ClerkProvider>\n      <html lang=\"en\">\n        <body>{children}</body>\n      </html>\n    </ClerkProvider>\n  );\n}\n```\n\n```css file=\"app/globals.css\"\n* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\nbody {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,\n    Ubuntu, Cantarell, sans-serif;\n  background: #f5f5f5;\n  color: #333;\n}\n\n.container {\n  max-width: 1200px;\n  margin: 0 auto;\n  padding: 20px;\n}\n\n.header {\n  background: white;\n  border-bottom: 1px solid #e0e0e0;\n  padding: 16px 0;\n  margin-bottom: 32px;\n}\n\n.header-content {\n  max-width: 1200px;\n  margin: 0 auto;\n  padding: 0 20px;\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n}\n\n.logo {\n  font-size: 24px;\n  font-weight: bold;\n  color: #6c47ff;\n}\n\n.card {\n  background: white;\n  border-radius: 8px;\n  padding: 24px;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n  margin-bottom: 24px;\n}\n\n.button {\n  background: #6c47ff;\n  color: white;\n  border: none;\n  padding: 12px 24px;\n  border-radius: 6px;\n  font-size: 16px;\n  cursor: pointer;\n  text-decoration: none;\n  display: inline-block;\n  transition: background 0.2s;\n}\n\n.button:hover {\n  background: #5639cc;\n}\n\n.org-list {\n  display: grid;\n  gap: 16px;\n  margin-top: 24px;\n}\n\n.org-card {\n  background: white;\n  border: 2px solid #e0e0e0;\n  border-radius: 8px;\n  padding: 20px;\n  cursor: pointer;\n  transition: all 0.2s;\n}\n\n.org-card:hover {\n  border-color: #6c47ff;\n  box-shadow: 0 4px 12px rgba(108, 71, 255, 0.15);\n}\n\n.org-name {\n  font-size: 20px;\n  font-weight: 600;\n  margin-bottom: 8px;\n}\n\n.org-slug {\n  color: #666;\n  font-size: 14px;\n}\n\n.dashboard-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n  gap: 24px;\n  margin-top: 24px;\n}\n\n.stat-card {\n  background: linear-gradient(135deg, #6c47ff 0%, #8b5cf6 100%);\n  color: white;\n  border-radius: 8px;\n  padding: 24px;\n}\n\n.stat-value {\n  font-size: 32px;\n  font-weight: bold;\n  margin-bottom: 8px;\n}\n\n.stat-label {\n  font-size: 14px;\n  opacity: 0.9;\n}\n```\n\n```typescript file=\"app/page.tsx\"\nimport { auth } from '@clerk/nextjs/server';\nimport { redirect } from 'next/navigation';\nimport Link from 'next/link';\n\nexport default async function HomePage() {\n  const { userId, orgSlug } = await auth();\n\n  if (userId) {\n    if (orgSlug) {\n      redirect(`/orgs/${orgSlug}/dashboard`);\n    } else {\n      redirect('/select-org');\n    }\n  }\n\n  return (\n    <div className=\"container\">\n      <div className=\"header\">\n        <div className=\"header-content\">\n          <div className=\"logo\">üêæ Petstore</div>\n        </div>\n      </div>\n\n      <div className=\"card\" style={{ textAlign: 'center', marginTop: '100px' }}>\n        <h1 style={{ fontSize: '48px', marginBottom: '16px' }}>Welcome to Petstore</h1>\n        <p style={{ fontSize: '20px', color: '#666', marginBottom: '32px' }}>\n          Multi-tenant B2B platform with organization management\n        </p>\n        <div style={{ display: 'flex', gap: '16px', justifyContent: 'center' }}>\n          <Link href=\"/sign-in\" className=\"button\">\n            Sign In\n          </Link>\n          <Link href=\"/sign-up\" className=\"button\" style={{ background: '#f0f0f0', color: '#333' }}>\n            Sign Up\n          </Link>\n        </div>\n      </div>\n    </div>\n  );\n}\n```\n\n```typescript file=\"app/sign-in/[[...sign-in]]/page.tsx\"\nimport { SignIn } from '@clerk/nextjs';\n\nexport default function SignInPage() {\n  return (\n    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh' }}>\n      <SignIn \n        routing=\"path\"\n        path=\"/sign-in\"\n        signUpUrl=\"/sign-up\"\n        afterSignInUrl=\"/select-org\"\n      />\n    </div>\n  );\n}\n```\n\n```typescript file=\"app/sign-up/[[...sign-up]]/page.tsx\"\nimport { SignUp } from '@clerk/nextjs';\n\nexport default function SignUpPage() {\n  return (\n    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh' }}>\n      <SignUp \n        routing=\"path\"\n        path=\"/sign-up\"\n        signInUrl=\"/sign-in\"\n        afterSignUpUrl=\"/select-org\"\n      />\n    </div>\n  );\n}\n```\n\n```typescript file=\"app/select-org/page.tsx\"\nimport { auth } from '@clerk/nextjs/server';\nimport { redirect } from 'next/navigation';\nimport { OrganizationList } from '@clerk/nextjs';\n\nexport default async function SelectOrgPage() {\n  const { userId, orgSlug } = await auth();\n\n  if (!userId) {\n    redirect('/sign-in');\n  }\n\n  // If user already has an active org, redirect to dashboard\n  if (orgSlug) {\n    redirect(`/orgs/${orgSlug}/dashboard`);\n  }\n\n  return (\n    <div className=\"container\">\n      <div className=\"header\">\n        <div className=\"header-content\">\n          <div className=\"logo\">üêæ Petstore</div>\n        </div>\n      </div>\n\n      <div className=\"card\" style={{ maxWidth: '600px', margin: '40px auto' }}>\n        <h1 style={{ marginBottom: '16px' }}>Select or Create an Organization</h1>\n        <p style={{ color: '#666', marginBottom: '24px' }}>\n          Choose an organization to continue or create a new one.\n        </p>\n        \n        <OrganizationList\n          hidePersonal\n          afterSelectOrganizationUrl={({ organization }) => `/orgs/${organization.slug}/dashboard`}\n          afterCreateOrganizationUrl={({ organization }) => `/orgs/${organization.slug}/dashboard`}\n        />\n      </div>\n    </div>\n  );\n}\n```\n\n```typescript file=\"app/orgs/[slug]/layout.tsx\"\nimport { auth, currentUser } from '@clerk/nextjs/server';\nimport { redirect } from 'next/navigation';\nimport { OrganizationSwitcher, UserButton } from '@clerk/nextjs';\n\nexport default async function OrgLayout({\n  children,\n  params,\n}: {\n  children: React.ReactNode;\n  params: Promise<{ slug: string }>;\n}) {\n  const { userId, orgSlug } = await auth();\n  const { slug } = await params;\n\n  if (!userId) {\n    redirect('/sign-in');\n  }\n\n  // Ensure the URL slug matches the user's current organization\n  if (orgSlug !== slug) {\n    redirect('/select-org');\n  }\n\n  const user = await currentUser();\n\n  return (\n    <div>\n      <div className=\"header\">\n        <div className=\"header-content\">\n          <div className=\"logo\">üêæ Petstore</div>\n          <div style={{ display: 'flex', gap: '16px', alignItems: 'center' }}>\n            <OrganizationSwitcher\n              hidePersonal\n              afterSelectOrganizationUrl={({ organization }) => `/orgs/${organization.slug}/dashboard`}\n            />\n            <UserButton afterSignOutUrl=\"/\" />\n          </div>\n        </div>\n      </div>\n\n      <div className=\"container\">\n        <div style={{ marginBottom: '24px' }}>\n          <div style={{ color: '#666', fontSize: '14px', marginBottom: '4px' }}>\n            Organization\n          </div>\n          <h2 style={{ fontSize: '24px', fontWeight: '600', textTransform: 'capitalize' }}>\n            {slug}\n          </h2>\n        </div>\n\n        {children}\n      </div>\n    </div>\n  );\n}\n```\n\n```typescript file=\"app/orgs/[slug]/dashboard/page.tsx\"\nimport { auth, clerkClient } from '@clerk/nextjs/server';\nimport { redirect } from 'next/navigation';\n\nexport default async function DashboardPage({\n  params,\n}: {\n  params: Promise<{ slug: string }>;\n}) {\n  const { userId, orgId } = await auth();\n  const { slug } = await params;\n\n  if (!userId || !orgId) {\n    redirect('/sign-in');\n  }\n\n  const client = await clerkClient();\n  const organization = await client.organizations.getOrganization({ organizationId: orgId });\n  const membershipList = await client.organizations.getOrganizationMembershipList({ organizationId: orgId });\n\n  return (\n    <div>\n      <div className=\"card\">\n        <h1 style={{ fontSize: '32px', marginBottom: '8px' }}>Dashboard</h1>\n        <p style={{ color: '#666' }}>\n          Welcome to your organization dashboard at <strong>/orgs/{slug}/dashboard</strong>\n        </p>\n      </div>\n\n      <div className=\"dashboard-grid\">\n        <div className=\"stat-card\">\n          <div className=\"stat-value\">{membershipList.data.length}</div>\n          <div className=\"stat-label\">Team Members</div>\n        </div>\n\n        <div className=\"stat-card\" style={{ background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)' }}>\n          <div className=\"stat-value\">Active</div>\n          <div className=\"stat-label\">Organization Status</div>\n        </div>\n\n        <div className=\"stat-card\" style={{ background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' }}>\n          <div className=\"stat-value\">{organization.name}</div>\n          <div className=\"stat-label\">Organization Name</div>\n        </div>\n      </div>\n\n      <div className=\"card\" style={{ marginTop: '24px' }}>\n        <h2 style={{ fontSize: '20px', marginBottom: '16px' }}>Organization Details</h2>\n        <div style={{ display: 'grid', gap: '12px' }}>\n          <div>\n            <strong>Name:</strong> {organization.name}\n          </div>\n          <div>\n            <strong>Slug:</strong> {organization.slug}\n          </div>\n          <div>\n            <strong>ID:</strong> {organization.id}\n          </div>\n          <div>\n            <strong>Created:</strong> {new Date(organization.createdAt).toLocaleDateString()}\n          </div>\n        </div>\n      </div>\n\n      <div className=\"card\">\n        <h2 style={{ fontSize: '20px', marginBottom: '16px' }}>Team Members</h2>\n        <div style={{ display: 'grid', gap: '12px' }}>\n          {membershipList.data.map((membership) => (\n            <div\n              key={membership.id}\n              style={{\n                padding: '12px',\n                background: '#f9f9f9',\n                borderRadius: '6px',\n                display: 'flex',\n                justifyContent: 'space-between',\n                alignItems: 'center',\n              }}\n            >\n              <div>\n                <div style={{ fontWeight: '600' }}>\n                  {membership.publicUserData.firstName} {membership.publicUserData.lastName}\n                </div>\n                <div style={{ fontSize: '14px', color: '#666' }}>\n                  {membership.publicUserData.identifier}\n                </div>\n              </div>\n              <div\n                style={{\n                  fontSize: '12px',\n                  padding: '4px 12px',\n                  background: '#6c47ff',\n                  color: 'white',\n                  borderRadius: '12px',\n                }}\n              >\n                {membership.role}\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n}\n```\n\n```typescript file=\"app/orgs/[slug]/settings/page.tsx\"\nimport { auth } from '@clerk/nextjs/server';\nimport { redirect } from 'next/navigation';\nimport { OrganizationProfile } from '@clerk/nextjs';\n\nexport default async function SettingsPage({\n  params,\n}: {\n  params: Promise<{ slug: string }>;\n}) {\n  const { userId } = await auth();\n  const { slug } = await params;\n\n  if (!userId) {\n    redirect('/sign-in');\n  }\n\n  return (\n    <div className=\"card\">\n      <h1 style={{ fontSize: '32px', marginBottom: '16px' }}>Organization Settings</h1>\n      <p style={{ color: '#666', marginBottom: '24px' }}>\n        Manage your organization settings, members, and preferences.\n      </p>\n      \n      <OrganizationProfile\n        routing=\"path\"\n        path={`/orgs/${slug}/settings`}\n      />\n    </div>\n  );\n}\n```\n\n```typescript file=\"tsconfig.json\"\n{\n  \"compilerOptions\": {\n    \"target\": \"ES2017\",\n    \"lib\": [\"dom\", \"dom.iterable\", \"esnext\"],\n    \"allowJs\": true,\n    \"skipLibCheck\": true,\n    \"strict\": true,\n    \"noEmit\": true,\n    \"esModuleInterop\": true,\n    \"module\": \"esnext\",\n    \"moduleResolution\": \"bundler\",\n    \"resolveJsonModule\": true,\n    \"isolatedModules\": true,\n    \"jsx\": \"preserve\",\n    \"incremental\": true,\n    \"plugins\": [\n      {\n        \"name\": \"next\"\n      }\n    ],\n    \"paths\": {\n      \"@/*\": [\"./*\"]\n    }\n  },\n  \"include\": [\"next-env.d.ts\", \"**/*.ts\", \"**/*.tsx\", \".next/types/**/*.ts\"],\n  \"exclude\": [\"node_modules\"]\n}\n```\n\n```json file=\"next.config.js\"\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n}\n\nmodule.exports = nextConfig\n```\n\n```markdown file=\"README.md\"\n# Clerk Organization Slug Sync - Next.js App\n\nA B2B multi-tenant application that syncs Clerk organization slugs with URL paths.\n\n## Features\n\n- **Organization-based routing**: Each organization has its own URL space (`/orgs/:slug/dashboard`)\n- **Automatic slug syncing**: Middleware ensures URL slug matches user's active organization\n- **Organization switcher**: Switch between organizations with automatic URL updates\n- **Protected routes**: All org routes require authentication and org membership\n- **Organization management**: Full member management and settings via Clerk components\n\n## Getting Started\n\n### 1. Install Dependencies\n\n```bash\nnpm install\n```\n\n### 2. Set up Clerk\n\n1. Create a Clerk application at [clerk.com](https://clerk.com)\n2. Enable organizations in your Clerk dashboard\n3. Copy your API keys to `.env.local`:\n\n```env\nNEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...\nCLERK_SECRET_KEY=sk_test_...\n```\n\n### 3. Run the Development Server\n\n```bash\nnpm run dev\n```\n\nOpen [http://localhost:3000](http://localhost:3000) in your browser.\n\n## How It Works\n\n### URL Structure\n\n- `/` - Public landing page\n- `/sign-in` - Sign in page\n- `/sign-up` - Sign up page\n- `/select-org` - Organization selection/creation\n- `/orgs/[slug]/dashboard` - Organization dashboard\n- `/orgs/[slug]/settings` - Organization settings\n\n### Middleware Logic\n\nThe middleware (`middleware.ts`) handles:\n\n1. **Authentication**: Redirects unauthenticated users to sign-in\n2. **Slug validation**: Ensures URL slug matches user's active organization\n3. **Auto-redirect**: Redirects users to correct org URL if mismatch detected\n4. **Org selection**: Redirects users without active org to selection page\n\n### Example Flow\n\n1. User signs in ‚Üí Redirected to `/select-org`\n2. User selects \"Acmecorp\" org ‚Üí Redirected to `/orgs/acmecorp/dashboard`\n3. User switches to \"Widgetco\" ‚Üí Automatically redirected to `/orgs/widgetco/dashboard`\n4. User tries to access `/orgs/acmecorp/...` while in Widgetco ‚Üí Redirected to `/orgs/widgetco/...`\n\n## Key Components\n\n- **middleware.ts**: Handles authentication and org slug syncing\n- **app/orgs/[slug]/layout.tsx**: Org layout with switcher and user button\n- **app/orgs/[slug]/dashboard/page.tsx**: Main dashboard with org details\n- **app/select-org/page.tsx**: Organization selection interface\n\n## Customization\n\n### Adding New Org Routes\n\nAdd new pages under `app/orgs/[slug]/`:\n\n```typescript\n// app/orgs/[slug]/analytics/page.tsx\nexport default async function AnalyticsPage({\n  params,\n}: {\n  params: Promise<{ slug: string }>;\n}) {\n  const { slug } = await params;\n  // Your page content\n}\n```\n\nThe middleware automatically protects these routes and ensures slug syncing.\n\n### Styling\n\nModify `app/globals.css` to customize the appearance. The app uses a clean, minimal design system with CSS-in-JS for component-specific styles.\n\n## Learn More\n\n- [Clerk Documentation](https://clerk.com/docs)\n- [Clerk Organizations Guide](https://clerk.com/docs/organizations/overview)\n- [Next.js Documentation](https://nextjs.org/docs)\n```\n\nThis creates a complete Next.js application with:\n\n1. **Organization slug syncing** - URLs automatically reflect the active organization\n2. **Protected routes** - All org routes require authentication and membership\n3. **Automatic redirects** - Middleware ensures users are always on the correct org URL\n4. **Organization switcher** - Switch orgs with automatic URL updates\n5. **Full organization management** - Member management, settings, and details\n6. **Clean UI** - Professional B2B application design\n\nThe key feature is the middleware that enforces URL/org synchronization, ensuring users at `/orgs/acmecorp/dashboard` are always members of the Acmecorp organization.\n",
  "graders": [
    [
      "import_package",
      true
    ],
    [
      "import_function",
      true
    ],
    [
      "middleware_file_name",
      true
    ],
    [
      "orgs_dynamic_route",
      true
    ],
    [
      "package_json_clerk_version",
      true
    ],
    [
      "environment_variables",
      true
    ],
    [
      "org_slug_from_await_auth",
      true
    ]
  ],
  "transcript": "# Claude Code Agent Transcript\n\n## Execution Info\n- **Duration**: 73.54s\n- **Exit Code**: 0\n- **Success**: true\n\n## Prompt\n```markdown\nYOU MUST output all files as fenced code blocks, like so\n\n```lang file=\"path/to/file.ts\"\n// file content\n```\n\nDo not ask clarifying questions. Complete the task with the information provided.\n\n---\n\nCreate a Next.js app with Clerk authentication. The application should sync the Clerk Organization slug with the URL.\n\nFor example, a B2B application named \"Petstore\" has two customer organizations: Acmecorp and Widgetco. Each organization uses its name as a slug in the URL:\n\nAcmecorp: https://petstore.example.com/orgs/acmecorp/dashboard\nWidgetco: https://petstore.example.com/orgs/widgetco/dashboard\n```\n\n## Output\n```\nI'll create a Next.js app with Clerk authentication that syncs the organization slug with the URL. This will be a B2B multi-tenant application structure.\n\n```typescript file=\"package.json\"\n{\n  \"name\": \"clerk-org-slug-sync\",\n  \"version\": \"0.1.0\",\n  \"private\": true,\n  \"scripts\": {\n    \"dev\": \"next dev\",\n    \"build\": \"next build\",\n    \"start\": \"next start\",\n    \"lint\": \"next lint\"\n  },\n  \"dependencies\": {\n    \"@clerk/nextjs\": \"^6.14.7\",\n    \"next\": \"15.1.6\",\n    \"react\": \"^19.0.0\",\n    \"react-dom\": \"^19.0.0\"\n  },\n  \"devDependencies\": {\n    \"@types/node\": \"^20\",\n    \"@types/react\": \"^19\",\n    \"@types/react-dom\": \"^19\",\n    \"eslint\": \"^8\",\n    \"eslint-config-next\": \"15.1.6\",\n    \"typescript\": \"^5\"\n  }\n}\n```\n\n```typescript file=\".env.local\"\nNEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=your_publishable_key_here\nCLERK_SECRET_KEY=your_secret_key_here\nNEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in\nNEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up\n```\n\n```typescript file=\"middleware.ts\"\nimport { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server';\nimport { NextResponse } from 'next/server';\n\nconst isPublicRoute = createRouteMatcher([\n  '/sign-in(.*)',\n  '/sign-up(.*)',\n  '/',\n]);\n\nconst isOrgRoute = createRouteMatcher(['/orgs/:slug(.*)']);\n\nexport default clerkMiddleware(async (auth, req) => {\n  const { userId, orgSlug, redirectToSignIn } = await auth();\n\n  // Allow public routes\n  if (isPublicRoute(req)) {\n    return NextResponse.next();\n  }\n\n  // Redirect to sign-in if not authenticated\n  if (!userId) {\n    return redirectToSignIn();\n  }\n\n  // Handle organization routes\n  if (isOrgRoute(req)) {\n    const url = new URL(req.url);\n    const pathSegments = url.pathname.split('/');\n    const urlSlug = pathSegments[2]; // /orgs/[slug]/...\n\n    // If user is in an org but URL doesn't match, redirect to correct org URL\n    if (orgSlug && urlSlug !== orgSlug) {\n      const newPath = url.pathname.replace(`/orgs/${urlSlug}`, `/orgs/${orgSlug}`);\n      return NextResponse.redirect(new URL(newPath, req.url));\n    }\n\n    // If URL has a slug but user isn't in that org, redirect to org selection\n    if (!orgSlug && urlSlug) {\n      return NextResponse.redirect(new URL('/select-org', req.url));\n    }\n  }\n\n  // If authenticated but not in org route and has org, redirect to org dashboard\n  if (userId && orgSlug && !isOrgRoute(req) && req.nextUrl.pathname !== '/select-org') {\n    return NextResponse.redirect(new URL(`/orgs/${orgSlug}/dashboard`, req.url));\n  }\n\n  // If authenticated but no org, redirect to org selection\n  if (userId && !orgSlug && !isOrgRoute(req) && req.nextUrl.pathname !== '/select-org') {\n    return NextResponse.redirect(new URL('/select-org', req.url));\n  }\n\n  return NextResponse.next();\n});\n\nexport const config = {\n  matcher: [\n    '/((?!_next|[^?]*\\\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',\n    '/(api|trpc)(.*)',\n  ],\n};\n```\n\n```typescript file=\"app/layout.tsx\"\nimport { ClerkProvider } from '@clerk/nextjs';\nimport type { Metadata } from 'next';\nimport './globals.css';\n\nexport const metadata: Metadata = {\n  title: 'Petstore - B2B Application',\n  description: 'Multi-tenant B2B application with Clerk organization management',\n};\n\nexport default function RootLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  return (\n    <ClerkProvider>\n      <html lang=\"en\">\n        <body>{children}</body>\n      </html>\n    </ClerkProvider>\n  );\n}\n```\n\n```css file=\"app/globals.css\"\n* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\nbody {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,\n    Ubuntu, Cantarell, sans-serif;\n  background: #f5f5f5;\n  color: #333;\n}\n\n.container {\n  max-width: 1200px;\n  margin: 0 auto;\n  padding: 20px;\n}\n\n.header {\n  background: white;\n  border-bottom: 1px solid #e0e0e0;\n  padding: 16px 0;\n  margin-bottom: 32px;\n}\n\n.header-content {\n  max-width: 1200px;\n  margin: 0 auto;\n  padding: 0 20px;\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n}\n\n.logo {\n  font-size: 24px;\n  font-weight: bold;\n  color: #6c47ff;\n}\n\n.card {\n  background: white;\n  border-radius: 8px;\n  padding: 24px;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n  margin-bottom: 24px;\n}\n\n.button {\n  background: #6c47ff;\n  color: white;\n  border: none;\n  padding: 12px 24px;\n  border-radius: 6px;\n  font-size: 16px;\n  cursor: pointer;\n  text-decoration: none;\n  display: inline-block;\n  transition: background 0.2s;\n}\n\n.button:hover {\n  background: #5639cc;\n}\n\n.org-list {\n  display: grid;\n  gap: 16px;\n  margin-top: 24px;\n}\n\n.org-card {\n  background: white;\n  border: 2px solid #e0e0e0;\n  border-radius: 8px;\n  padding: 20px;\n  cursor: pointer;\n  transition: all 0.2s;\n}\n\n.org-card:hover {\n  border-color: #6c47ff;\n  box-shadow: 0 4px 12px rgba(108, 71, 255, 0.15);\n}\n\n.org-name {\n  font-size: 20px;\n  font-weight: 600;\n  margin-bottom: 8px;\n}\n\n.org-slug {\n  color: #666;\n  font-size: 14px;\n}\n\n.dashboard-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n  gap: 24px;\n  margin-top: 24px;\n}\n\n.stat-card {\n  background: linear-gradient(135deg, #6c47ff 0%, #8b5cf6 100%);\n  color: white;\n  border-radius: 8px;\n  padding: 24px;\n}\n\n.stat-value {\n  font-size: 32px;\n  font-weight: bold;\n  margin-bottom: 8px;\n}\n\n.stat-label {\n  font-size: 14px;\n  opacity: 0.9;\n}\n```\n\n```typescript file=\"app/page.tsx\"\nimport { auth } from '@clerk/nextjs/server';\nimport { redirect } from 'next/navigation';\nimport Link from 'next/link';\n\nexport default async function HomePage() {\n  const { userId, orgSlug } = await auth();\n\n  if (userId) {\n    if (orgSlug) {\n      redirect(`/orgs/${orgSlug}/dashboard`);\n    } else {\n      redirect('/select-org');\n    }\n  }\n\n  return (\n    <div className=\"container\">\n      <div className=\"header\">\n        <div className=\"header-content\">\n          <div className=\"logo\">üêæ Petstore</div>\n        </div>\n      </div>\n\n      <div className=\"card\" style={{ textAlign: 'center', marginTop: '100px' }}>\n        <h1 style={{ fontSize: '48px', marginBottom: '16px' }}>Welcome to Petstore</h1>\n        <p style={{ fontSize: '20px', color: '#666', marginBottom: '32px' }}>\n          Multi-tenant B2B platform with organization management\n        </p>\n        <div style={{ display: 'flex', gap: '16px', justifyContent: 'center' }}>\n          <Link href=\"/sign-in\" className=\"button\">\n            Sign In\n          </Link>\n          <Link href=\"/sign-up\" className=\"button\" style={{ background: '#f0f0f0', color: '#333' }}>\n            Sign Up\n          </Link>\n        </div>\n      </div>\n    </div>\n  );\n}\n```\n\n```typescript file=\"app/sign-in/[[...sign-in]]/page.tsx\"\nimport { SignIn } from '@clerk/nextjs';\n\nexport default function SignInPage() {\n  return (\n    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh' }}>\n      <SignIn \n        routing=\"path\"\n        path=\"/sign-in\"\n        signUpUrl=\"/sign-up\"\n        afterSignInUrl=\"/select-org\"\n      />\n    </div>\n  );\n}\n```\n\n```typescript file=\"app/sign-up/[[...sign-up]]/page.tsx\"\nimport { SignUp } from '@clerk/nextjs';\n\nexport default function SignUpPage() {\n  return (\n    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh' }}>\n      <SignUp \n        routing=\"path\"\n        path=\"/sign-up\"\n        signInUrl=\"/sign-in\"\n        afterSignUpUrl=\"/select-org\"\n      />\n    </div>\n  );\n}\n```\n\n```typescript file=\"app/select-org/page.tsx\"\nimport { auth } from '@clerk/nextjs/server';\nimport { redirect } from 'next/navigation';\nimport { OrganizationList } from '@clerk/nextjs';\n\nexport default async function SelectOrgPage() {\n  const { userId, orgSlug } = await auth();\n\n  if (!userId) {\n    redirect('/sign-in');\n  }\n\n  // If user already has an active org, redirect to dashboard\n  if (orgSlug) {\n    redirect(`/orgs/${orgSlug}/dashboard`);\n  }\n\n  return (\n    <div className=\"container\">\n      <div className=\"header\">\n        <div className=\"header-content\">\n          <div className=\"logo\">üêæ Petstore</div>\n        </div>\n      </div>\n\n      <div className=\"card\" style={{ maxWidth: '600px', margin: '40px auto' }}>\n        <h1 style={{ marginBottom: '16px' }}>Select or Create an Organization</h1>\n        <p style={{ color: '#666', marginBottom: '24px' }}>\n          Choose an organization to continue or create a new one.\n        </p>\n        \n        <OrganizationList\n          hidePersonal\n          afterSelectOrganizationUrl={({ organization }) => `/orgs/${organization.slug}/dashboard`}\n          afterCreateOrganizationUrl={({ organization }) => `/orgs/${organization.slug}/dashboard`}\n        />\n      </div>\n    </div>\n  );\n}\n```\n\n```typescript file=\"app/orgs/[slug]/layout.tsx\"\nimport { auth, currentUser } from '@clerk/nextjs/server';\nimport { redirect } from 'next/navigation';\nimport { OrganizationSwitcher, UserButton } from '@clerk/nextjs';\n\nexport default async function OrgLayout({\n  children,\n  params,\n}: {\n  children: React.ReactNode;\n  params: Promise<{ slug: string }>;\n}) {\n  const { userId, orgSlug } = await auth();\n  const { slug } = await params;\n\n  if (!userId) {\n    redirect('/sign-in');\n  }\n\n  // Ensure the URL slug matches the user's current organization\n  if (orgSlug !== slug) {\n    redirect('/select-org');\n  }\n\n  const user = await currentUser();\n\n  return (\n    <div>\n      <div className=\"header\">\n        <div className=\"header-content\">\n          <div className=\"logo\">üêæ Petstore</div>\n          <div style={{ display: 'flex', gap: '16px', alignItems: 'center' }}>\n            <OrganizationSwitcher\n              hidePersonal\n              afterSelectOrganizationUrl={({ organization }) => `/orgs/${organization.slug}/dashboard`}\n            />\n            <UserButton afterSignOutUrl=\"/\" />\n          </div>\n        </div>\n      </div>\n\n      <div className=\"container\">\n        <div style={{ marginBottom: '24px' }}>\n          <div style={{ color: '#666', fontSize: '14px', marginBottom: '4px' }}>\n       \n... (truncated)\n```\n\n## Grader Results\n**Score: 100.0%** (7/7)\n\n| Grader | Result |\n|--------|--------|\n| import_package | PASS |\n| import_function | PASS |\n| middleware_file_name | PASS |\n| orgs_dynamic_route | PASS |\n| package_json_clerk_version | PASS |\n| environment_variables | PASS |\n| org_slug_from_await_auth | PASS |\n"
}