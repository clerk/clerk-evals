{
  "prompt": "# Task\n\nBuild a Clerk-enabled Next.js App Router admin area that enforces both authentication and authorization for an organization settings page.\n",
  "response": "I'll help you build a Clerk-enabled Next.js App Router admin area with authentication and authorization for organization settings. Let me get the relevant code snippets for this implementation.\n\nNow I'll create a comprehensive Clerk-enabled Next.js App Router admin area with authentication and authorization for organization settings. Based on the snippets, I'll build a complete solution:\n\n## 1. Project Setup\n\n```typescript file=\"app/layout.tsx\"\nimport {\n  ClerkProvider,\n  SignedIn,\n  SignedOut,\n  UserButton,\n  OrganizationSwitcher,\n} from '@clerk/nextjs';\n\nexport default function RootLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  return (\n    <ClerkProvider>\n      <html lang=\"en\">\n        <body>\n          <header className=\"border-b bg-white p-4\">\n            <div className=\"mx-auto flex max-w-7xl items-center justify-between\">\n              <h1 className=\"text-xl font-bold\">Admin Dashboard</h1>\n              \n              <div className=\"flex items-center gap-4\">\n                <SignedOut>\n                  <a \n                    href=\"/sign-in\" \n                    className=\"rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700\"\n                  >\n                    Sign In\n                  </a>\n                </SignedOut>\n                \n                <SignedIn>\n                  <OrganizationSwitcher \n                    hidePersonal={true}  // Force org selection for B2B\n                    afterSelectOrganizationUrl=\"/admin\"\n                    afterCreateOrganizationUrl=\"/admin/onboarding\"\n                    afterLeaveOrganizationUrl=\"/select-org\"\n                    appearance={{\n                      elements: {\n                        organizationSwitcherTrigger: 'border rounded-lg px-4 py-2 hover:bg-gray-50',\n                      },\n                    }}\n                  />\n                  <UserButton \n                    afterSignOutUrl=\"/\"\n                    appearance={{\n                      elements: {\n                        avatarBox: 'w-8 h-8',\n                      },\n                    }}\n                  />\n                </SignedIn>\n              </div>\n            </div>\n          </header>\n          \n          <main>{children}</main>\n        </body>\n      </html>\n    </ClerkProvider>\n  );\n}\n```\n\n## 2. Middleware for Route Protection\n\n```typescript file=\"middleware.ts\"\nimport { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server';\n\nconst isProtectedRoute = createRouteMatcher(['/admin(.*)']);\nconst isAdminRoute = createRouteMatcher(['/admin/settings(.*)']);\nconst isBillingRoute = createRouteMatcher(['/admin/billing(.*)']);\n\nexport default clerkMiddleware(async (auth, req) => {\n  const { userId, orgId, orgRole } = await auth();\n  \n  if (isProtectedRoute(req)) {\n    // Require authentication\n    await auth.protect();\n    \n    // Require organization for admin area\n    if (!orgId && !req.nextUrl.pathname.includes('/select-org')) {\n      return Response.redirect(new URL('/select-org', req.url));\n    }\n  }\n\n  if (isAdminRoute(req)) {\n    // Only admins can access organization settings\n    if (orgRole !== 'org:admin') {\n      return Response.redirect(new URL('/admin?error=insufficient-permissions', req.url));\n    }\n  }\n\n  if (isBillingRoute(req)) {\n    // Only admins and billing managers can access billing\n    if (!orgRole?.includes('admin') && !orgRole?.includes('billing')) {\n      return Response.redirect(new URL('/admin?error=insufficient-permissions', req.url));\n    }\n  }\n});\n\nexport const config = {\n  matcher: ['/((?!.*\\\\..*|_next).*)', '/', '/(api|trpc)(.*)'],\n};\n```\n\n## 3. Organization Selection Page\n\n```typescript file=\"app/select-org/page.tsx\"\n'use client';\n\nimport { useOrganizationList } from '@clerk/clerk-react';\nimport { useRouter } from 'next/navigation';\nimport { useState } from 'react';\n\nexport default function SelectOrgPage() {\n  const router = useRouter();\n  const [isCreating, setIsCreating] = useState(false);\n  const { \n    isLoaded,\n    setActive,\n    userMemberships,\n    userInvitations,\n    createOrganization,\n  } = useOrganizationList({\n    userMemberships: { infinite: true },\n    userInvitations: { infinite: true },\n  });\n\n  if (!isLoaded) {\n    return <div className=\"flex justify-center p-8\">Loading...</div>;\n  }\n\n  const switchOrg = async (orgId: string) => {\n    await setActive({ organization: orgId });\n    router.push('/admin');\n  };\n\n  const handleCreateOrg = async (name: string) => {\n    setIsCreating(true);\n    try {\n      const org = await createOrganization({ name });\n      await setActive({ organization: org.id });\n      router.push('/admin/onboarding');\n    } catch (error) {\n      console.error('Error creating organization:', error);\n    }\n    setIsCreating(false);\n  };\n\n  return (\n    <div className=\"mx-auto max-w-2xl p-8\">\n      <h1 className=\"mb-8 text-2xl font-bold\">Select Organization</h1>\n\n      {userMemberships?.data?.length > 0 && (\n        <div className=\"mb-8\">\n          <h2 className=\"mb-4 text-lg font-semibold\">Your Organizations</h2>\n          <div className=\"space-y-2\">\n            {userMemberships.data.map((mem) => (\n              <button\n                key={mem.id}\n                onClick={() => switchOrg(mem.organization.id)}\n                className=\"flex w-full items-center justify-between rounded-lg border p-4 hover:bg-gray-50\"\n              >\n                <div className=\"flex items-center gap-3\">\n                  <img\n                    src={mem.organization.imageUrl}\n                    alt={mem.organization.name}\n                    className=\"h-10 w-10 rounded\"\n                  />\n                  <div className=\"text-left\">\n                    <p className=\"font-medium\">{mem.organization.name}</p>\n                    <p className=\"text-sm text-gray-600\">Role: {mem.role}</p>\n                  </div>\n                </div>\n              </button>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {userInvitations?.data?.length > 0 && (\n        <div className=\"mb-8\">\n          <h2 className=\"mb-4 text-lg font-semibold\">Pending Invitations</h2>\n          <div className=\"space-y-2\">\n            {userInvitations.data.map((inv) => (\n              <div key={inv.id} className=\"flex items-center justify-between rounded-lg border p-4\">\n                <div>\n                  <p className=\"font-medium\">{inv.publicOrganizationData.name}</p>\n                  <p className=\"text-sm text-gray-600\">Role: {inv.role}</p>\n                </div>\n                <div className=\"flex gap-2\">\n                  <button\n                    onClick={() => inv.accept()}\n                    className=\"rounded bg-green-600 px-3 py-1 text-sm text-white hover:bg-green-700\"\n                  >\n                    Accept\n                  </button>\n                  <button\n                    onClick={() => inv.reject()}\n                    className=\"rounded bg-red-600 px-3 py-1 text-sm text-white hover:bg-red-700\"\n                  >\n                    Decline\n                  </button>\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      <div>\n        <h2 className=\"mb-4 text-lg font-semibold\">Create New Organization</h2>\n        <form\n          onSubmit={(e) => {\n            e.preventDefault();\n            const formData = new FormData(e.currentTarget);\n            const name = formData.get('name') as string;\n            if (name) handleCreateOrg(name);\n          }}\n          className=\"flex gap-2\"\n        >\n          <input\n            name=\"name\"\n            type=\"text\"\n            placeholder=\"Organization name\"\n            required\n            className=\"flex-1 rounded border px-3 py-2\"\n          />\n          <button\n            type=\"submit\"\n            disabled={isCreating}\n            className=\"rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 disabled:opacity-50\"\n          >\n            {isCreating ? 'Creating...' : 'Create'}\n          </button>\n        </form>\n      </div>\n    </div>\n  );\n}\n```\n\n## 4. Admin Dashboard Layout\n\n```typescript file=\"app/admin/layout.tsx\"\nimport { auth } from '@clerk/nextjs/server';\nimport { redirect } from 'next/navigation';\nimport AdminSidebar from './components/AdminSidebar';\n\nexport default async function AdminLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  const { userId, orgId } = await auth();\n\n  if (!userId) {\n    redirect('/sign-in');\n  }\n\n  if (!orgId) {\n    redirect('/select-org');\n  }\n\n  return (\n    <div className=\"flex min-h-screen\">\n      <AdminSidebar />\n      <div className=\"flex-1 p-8\">{children}</div>\n    </div>\n  );\n}\n```\n\n## 5. Admin Sidebar with Role-Based Access\n\n```typescript file=\"app/admin/components/AdminSidebar.tsx\"\n'use client';\n\nimport { useOrganization } from '@clerk/clerk-react';\nimport { Protect } from '@clerk/clerk-react';\nimport Link from 'next/link';\nimport { usePathname } from 'next/navigation';\n\nexport default function AdminSidebar() {\n  const { organization, membership } = useOrganization();\n  const pathname = usePathname();\n\n  const navItems = [\n    { href: '/admin', label: 'Dashboard', icon: 'üìä' },\n    { href: '/admin/team', label: 'Team', icon: 'üë•' },\n  ];\n\n  const adminItems = [\n    { href: '/admin/settings', label: 'Settings', icon: '‚öôÔ∏è' },\n    { href: '/admin/billing', label: 'Billing', icon: 'üí≥' },\n  ];\n\n  return (\n    <aside className=\"w-64 border-r bg-gray-50 p-6\">\n      <div className=\"mb-6\">\n        <h2 className=\"text-lg font-semibold\">{organization?.name}</h2>\n        <p className=\"text-sm text-gray-600\">\n          Role: {membership?.role}\n        </p>\n      </div>\n\n      <nav className=\"space-y-2\">\n        {navItems.map((item) => (\n          <Link\n            key={item.href}\n            href={item.href}\n            className={`flex items-center gap-3 rounded-lg px-3 py-2 text-sm transition-colors ${\n              pathname === item.href\n                ? 'bg-blue-100 text-blue-700'\n                : 'hover:bg-gray-100'\n            }`}\n          >\n            <span>{item.icon}</span>\n            {item.label}\n          </Link>\n        ))}\n\n        <div className=\"mt-6\">\n          <div className=\"mb-2 text-xs font-semibold uppercase text-gray-400\">\n            Admin Only\n          </div>\n          {adminItems.map((item) => (\n            <Protect\n              key={item.href}\n              role=\"org:admin\"\n              fallback={\n                <div className=\"flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-gray-400\">\n                  <span>{item.icon}</span>\n                  {item.label}\n                  <span className=\"ml-auto text-xs\">Admin only</span>\n                </div>\n              }\n            >\n              <Link\n                href={item.href}\n                className={`flex items-center gap-3 rounded-lg px-3 py-2 text-sm transition-colors ${\n                  pathname === item.href\n                    ? 'bg-blue-100 text-blue-700'\n                    : 'hover:bg-gray-100'\n                }`}\n              >\n                <span>{item.icon}</span>\n                {item.label}\n              </Link>\n            </Protect>\n          ))}\n        </div>\n      </nav>\n    </aside>\n  );\n}\n```\n\n## 6. Organization Settings Page\n\n```typescript file=\"app/admin/settings/page.tsx\"\n'use client';\n\nimport { useOrganization } from '@clerk/clerk-react';\nimport { useState } from 'react';\nimport { Protect } from '@clerk/clerk-react';\n\nexport default function OrganizationSettingsPage() {\n  const { organization, memberships, invitations } = useOrganization({\n    memberships: { infinite: true },\n    invitations: { infinite: true },\n  });\n  \n  const [orgName, setOrgName] = useState(organization?.name || '');\n  const [inviteEmail, setInviteEmail] = useState('');\n  const [inviteRole, setInviteRole] = useState<'admin' | 'basic_member'>('basic_member');\n  const [loading, setLoading] = useState(false);\n\n  const handleUpdateOrganization = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!organization) return;\n\n    setLoading(true);\n    try {\n      await organization.update({ name: orgName });\n    } catch (error) {\n      console.error('Error updating organization:', error);\n    }\n    setLoading(false);\n  };\n\n  const handleInviteMember = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!organization) return;\n\n    setLoading(true);\n    try {\n      await organization.inviteMember({\n        emailAddress: inviteEmail,\n        role: inviteRole,\n      });\n      setInviteEmail('');\n    } catch (error) {\n      console.error('Error inviting member:', error);\n    }\n    setLoading(false);\n  };\n\n  const handleRemoveMember = async (memberId: string) => {\n    if (!organization || !confirm('Are you sure you want to remove this member?')) return;\n\n    try {\n      await organization.removeMember(memberId);\n    } catch (error) {\n      console.error('Error removing member:', error);\n    }\n  };\n\n  const handleRevokeInvitation = async (invitationId: string) => {\n    if (!confirm('Are you sure you want to revoke this invitation?')) return;\n\n    try {\n      const invitation = invitations?.data?.find(inv => inv.id === invitationId);\n      await invitation?.revoke();\n    } catch (error) {\n      console.error('Error revoking invitation:', error);\n    }\n  };\n\n  if (!organization) {\n    return <div>Loading organization...</div>;\n  }\n\n  return (\n    <div className=\"max-w-4xl\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-2xl font-bold\">Organization Settings</h1>\n        <p className=\"text-gray-600\">Manage your organization details and team members</p>\n      </div>\n\n      {/* Organization Details */}\n      <div className=\"mb-8 rounded-lg border bg-white p-6\">\n        <h2 className=\"mb-4 text-lg font-semibold\">Organization Details</h2>\n        <form onSubmit={handleUpdateOrganization} className=\"space-y-4\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700\">\n              Organization Name\n            </label>\n            <input\n              type=\"text\"\n              value={orgName}\n              onChange={(e) => setOrgName(e.target.value)}\n              className=\"mt-1 w-full rounded border px-3",
  "graders": [
    ["admin_page_file", false],
    ["admin_route_handler_file", false],
    ["middleware_file_name", true],
    ["import_auth_helper", true],
    ["redirect_to_sign_in", false],
    ["auth_protect_usage", false],
    ["has_permission_check", false],
    ["package_json_clerk_version", false],
    ["environment_variables", false],
    ["authorization_logic", false]
  ],
  "toolCalls": [
    {
      "toolName": "clerk_sdk_snippet",
      "args": {}
    }
  ],
  "toolResults": [
    {
      "toolName": "clerk_sdk_snippet",
      "result": "# B2B-SAAS Bundle\n\nComplete B2B SaaS setup with organizations, billing, and role-based access\n\nIncludes: use-user, use-auth, use-organization, use-organization-list, b2b-saas-setup, billing-integration, organization-switcher, protect-component, server-auth-nextjs, clerk-client-backend\n\n---\n\n# useUser hook\n\nReturns the current user object and loading/signed-in state.\n\n```typescript\nimport { useUser } from '@clerk/clerk-react';\n\nexport function UserProfile() {\n  const { isLoaded, isSignedIn, user } = useUser();\n\n  if (!isLoaded) {\n    return <div>Loading...</div>;\n  }\n\n  if (!isSignedIn) {\n    return <div>Not signed in</div>;\n  }\n\n  return (\n    <div>\n      <h1>Welcome, {user.firstName}!</h1>\n      <p>Email: {user.primaryEmailAddress?.emailAddress}</p>\n      <img src={user.imageUrl} alt=\"Profile\" />\n    </div>\n  );\n}\n```\n\n## Return Type\n- `isLoaded: boolean` - Whether user data has loaded\n- `isSignedIn: boolean | undefined` - Whether user is signed in (undefined while loading)\n- `user: User | null | undefined` - The User object when signed in\n\n## Common User Properties\n- `user.id` - Unique user ID\n- `user.firstName`, `user.lastName`, `user.fullName`\n- `user.primaryEmailAddress?.emailAddress`\n- `user.imageUrl` - Profile image URL\n- `user.publicMetadata` - Public metadata (visible client-side)\n- `user.unsafeMetadata` - User-editable metadata\n\n---\n\n# useAuth hook\n\nReturns auth state and methods for getting tokens. Essential for making authenticated API calls.\n\n```typescript\nimport { useAuth } from '@clerk/clerk-react';\n\nexport function AuthenticatedApiCall() {\n  const { isLoaded, isSignedIn, userId, sessionId, getToken } = useAuth();\n\n  const fetchData = async () => {\n    // Get token for your own backend\n    const token = await getToken();\n    \n    // Or get token for a specific integration (e.g., Supabase, Firebase)\n    const supabaseToken = await getToken({ template: 'supabase' });\n    \n    const response = await fetch('/api/protected', {\n      headers: {\n        Authorization: `Bearer ${token}`,\n      },\n    });\n    return response.json();\n  };\n\n  if (!isLoaded) return <div>Loading...</div>;\n  if (!isSignedIn) return <div>Sign in to continue</div>;\n\n  return <button onClick={fetchData}>Fetch Protected Data</button>;\n}\n```\n\n## Return Type\n- `isLoaded: boolean` - Whether auth state has loaded\n- `isSignedIn: boolean | undefined` - Whether user is signed in\n- `userId: string | null | undefined` - Current user's ID\n- `sessionId: string | null | undefined` - Current session ID\n- `orgId: string | null | undefined` - Active organization ID (if any)\n- `orgRole: string | null | undefined` - User's role in active org\n- `orgSlug: string | null | undefined` - Active organization's slug\n- `getToken(options?)` - Get a session token for API calls\n- `signOut()` - Sign the user out\n\n## Token Templates\nUse `getToken({ template: 'name' })` to get JWTs customized for integrations:\n- `supabase` - For Supabase integration\n- `firebase` - For Firebase integration\n- `convex` - For Convex integration\n- Custom templates configured in Clerk Dashboard\n\n---\n\n# useOrganization hook\n\nAccess the currently active organization and manage its members, invitations, and settings.\n\n```typescript\nimport { useOrganization } from '@clerk/clerk-react';\n\nexport function OrganizationDashboard() {\n  const { \n    isLoaded, \n    organization, \n    membership,\n    memberships,\n    invitations,\n  } = useOrganization({\n    memberships: { infinite: true },\n    invitations: { infinite: true },\n  });\n\n  if (!isLoaded) return <div>Loading...</div>;\n  if (!organization) return <div>No organization selected</div>;\n\n  return (\n    <div>\n      <h1>{organization.name}</h1>\n      <img src={organization.imageUrl} alt={organization.name} />\n      <p>Your role: {membership?.role}</p>\n      <p>Members: {organization.membersCount}</p>\n      \n      <h2>Team Members</h2>\n      <ul>\n        {memberships?.data?.map((member) => (\n          <li key={member.id}>\n            {member.publicUserData.firstName} - {member.role}\n          </li>\n        ))}\n      </ul>\n\n      <h2>Pending Invitations</h2>\n      <ul>\n        {invitations?.data?.map((inv) => (\n          <li key={inv.id}>\n            {inv.emailAddress} - {inv.status}\n          </li>\n        ))}\n      </ul>\n    </div>\n  );\n}\n```\n\n## Inviting Members\n\n```typescript\nconst { organization } = useOrganization();\n\nconst inviteUser = async (email: string, role: 'admin' | 'member') => {\n  await organization?.inviteMember({\n    emailAddress: email,\n    role,\n  });\n};\n```\n\n## Updating Organization\n\n```typescript\nconst { organization } = useOrganization();\n\n// Update name\nawait organization?.update({ name: 'New Company Name' });\n\n// Update logo\nawait organization?.setLogo({ file: imageFile });\n```\n\n## Return Type\n- `organization` - The active Organization object\n- `membership` - Current user's membership in this org\n- `memberships` - Paginated list of all members\n- `invitations` - Paginated list of pending invitations\n- `membershipRequests` - Paginated list of membership requests\n\n---\n\n# useOrganizationList hook\n\nList all organizations a user belongs to and switch between them.\n\n```typescript\nimport { useOrganizationList } from '@clerk/clerk-react';\n\nexport function OrganizationSwitcher() {\n  const { \n    isLoaded,\n    setActive,\n    userMemberships,\n    userInvitations,\n    createOrganization,\n  } = useOrganizationList({\n    userMemberships: { infinite: true },\n    userInvitations: { infinite: true },\n  });\n\n  if (!isLoaded) return <div>Loading...</div>;\n\n  const switchOrg = async (orgId: string) => {\n    await setActive({ organization: orgId });\n  };\n\n  const handleCreateOrg = async () => {\n    const org = await createOrganization({ name: 'New Organization' });\n    await setActive({ organization: org.id });\n  };\n\n  return (\n    <div>\n      <h2>Your Organizations</h2>\n      <ul>\n        {userMemberships?.data?.map((mem) => (\n          <li key={mem.id}>\n            <button onClick={() => switchOrg(mem.organization.id)}>\n              {mem.organization.name} ({mem.role})\n            </button>\n          </li>\n        ))}\n      </ul>\n\n      <h2>Pending Invitations</h2>\n      <ul>\n        {userInvitations?.data?.map((inv) => (\n          <li key={inv.id}>\n            {inv.publicOrganizationData.name}\n            <button onClick={() => inv.accept()}>Accept</button>\n            <button onClick={() => inv.reject()}>Decline</button>\n          </li>\n        ))}\n      </ul>\n\n      <button onClick={handleCreateOrg}>Create Organization</button>\n    </div>\n  );\n}\n```\n\n## Switch to Personal Account\n\n```typescript\nconst { setActive } = useOrganizationList();\n\n// Set organization to null for personal account\nawait setActive({ organization: null });\n```\n\n## Return Type\n- `userMemberships` - Orgs the user is a member of\n- `userInvitations` - Pending invitations for the user\n- `userSuggestions` - Suggested organizations\n- `setActive()` - Switch active organization\n- `createOrganization()` - Create a new organization\n\n---\n\n# B2B SaaS Setup with Clerk (Next.js 15)\n\nComplete setup for a B2B SaaS application with organizations, roles, and billing.\n\n**Requirements**: Next.js 15+ with App Router\n\n## 1. Enable Organizations\n\nIn Clerk Dashboard:\n1. Go to **Organizations** ‚Üí **Settings**\n2. Enable **Organizations**\n3. Configure allowed roles (e.g., admin, member, billing)\n\n## 2. App Layout with Organization Support\n\n```typescript\n// app/layout.tsx (Next.js 15 App Router)\nimport {\n  ClerkProvider,\n  SignedIn,\n  SignedOut,\n  UserButton,\n  OrganizationSwitcher,\n} from '@clerk/nextjs';\n\nexport default function RootLayout({ children }) {\n  return (\n    <ClerkProvider>\n      <html>\n        <body>\n          <header>\n            <SignedOut>\n              <a href=\"/sign-in\">Sign In</a>\n            </SignedOut>\n            <SignedIn>\n              <OrganizationSwitcher \n                hidePersonal={true}  // Force org selection for B2B\n                afterSelectOrganizationUrl=\"/dashboard\"\n                afterCreateOrganizationUrl=\"/onboarding\"\n              />\n              <UserButton />\n            </SignedIn>\n          </header>\n          {children}\n        </body>\n      </html>\n    </ClerkProvider>\n  );\n}\n```\n\n## 3. Protect Routes by Organization\n\n```typescript\n// middleware.ts\nimport { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server';\n\nconst isProtectedRoute = createRouteMatcher(['/dashboard(.*)']);\nconst isAdminRoute = createRouteMatcher(['/dashboard/settings(.*)']);\n\nexport default clerkMiddleware(async (auth, req) => {\n  const { orgId, orgRole } = await auth();\n  \n  if (isProtectedRoute(req)) {\n    await auth.protect();\n    \n    // Require organization for dashboard\n    if (!orgId) {\n      return Response.redirect(new URL('/select-org', req.url));\n    }\n  }\n\n  if (isAdminRoute(req)) {\n    // Only admins can access settings\n    if (orgRole !== 'org:admin') {\n      return Response.redirect(new URL('/dashboard', req.url));\n    }\n  }\n});\n```\n\n## 4. Role-Based UI\n\n```typescript\nimport { useOrganization } from '@clerk/clerk-react';\nimport { Protect } from '@clerk/clerk-react';\n\nexport function DashboardSidebar() {\n  const { membership } = useOrganization();\n  const isAdmin = membership?.role === 'org:admin';\n\n  return (\n    <nav>\n      <a href=\"/dashboard\">Dashboard</a>\n      <a href=\"/dashboard/team\">Team</a>\n      \n      {/* Only show to admins */}\n      <Protect role=\"org:admin\">\n        <a href=\"/dashboard/settings\">Settings</a>\n        <a href=\"/dashboard/billing\">Billing</a>\n      </Protect>\n    </nav>\n  );\n}\n```\n\n## 5. Server-Side Organization Check\n\n```typescript\n// app/api/team/route.ts\nimport { auth } from '@clerk/nextjs/server';\n\nexport async function GET() {\n  const { userId, orgId, orgRole } = await auth();\n\n  if (!userId || !orgId) {\n    return Response.json({ error: 'Unauthorized' }, { status: 401 });\n  }\n\n  // Fetch team data scoped to organization\n  const team = await db.teamMembers.findMany({\n    where: { organizationId: orgId },\n  });\n\n  return Response.json(team);\n}\n```\n\n---\n\n# Stripe Billing Integration\n\nIntegrate Stripe subscriptions with Clerk for B2B billing.\n\n**Important**: All Stripe instances use API version `2025-02-24.clover`. Update this version if you encounter TypeScript errors about API version mismatches. Check [Stripe's API versioning docs](https://docs.stripe.com/api/versioning) for the latest version.\n\n## 1. Store Stripe Customer ID\n\n```typescript\n// When organization is created, create Stripe customer\nimport { clerkClient } from '@clerk/nextjs/server';\nimport Stripe from 'stripe';\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {\n  apiVersion: '2025-02-24.clover',\n});\n\nexport async function createStripeCustomer(orgId: string, orgName: string, email: string) {\n  const client = await clerkClient();\n  \n  const customer = await stripe.customers.create({\n    name: orgName,\n    email,\n    metadata: { clerkOrgId: orgId },\n  });\n\n  // Store Stripe customer ID in org metadata\n  await client.organizations.updateOrganization(orgId, {\n    publicMetadata: {\n      stripeCustomerId: customer.id,\n    },\n  });\n\n  return customer;\n}\n```\n\n## 2. Billing Page Component\n\n```typescript\n'use client';\nimport { useOrganization } from '@clerk/clerk-react';\nimport { useState } from 'react';\n\nexport function BillingPage() {\n  const { organization, membership } = useOrganization();\n  const [loading, setLoading] = useState(false);\n  \n  const isAdmin = membership?.role === 'org:admin';\n  const plan = organization?.publicMetadata?.plan as string || 'free';\n\n  const handleUpgrade = async (priceId: string) => {\n    setLoading(true);\n    const response = await fetch('/api/billing/create-checkout', {\n      method: 'POST',\n      body: JSON.stringify({ priceId }),\n    });\n    const { url } = await response.json();\n    window.location.href = url;\n  };\n\n  const handleManage = async () => {\n    const response = await fetch('/api/billing/create-portal', {\n      method: 'POST',\n    });\n    const { url } = await response.json();\n    window.location.href = url;\n  };\n\n  if (!isAdmin) {\n    return <p>Only admins can manage billing.</p>;\n  }\n\n  return (\n    <div>\n      <h1>Billing</h1>\n      <p>Current plan: {plan}</p>\n      \n      {plan === 'free' ? (\n        <div>\n          <button onClick={() => handleUpgrade('price_pro_monthly')}>\n            Upgrade to Pro\n          </button>\n          <button onClick={() => handleUpgrade('price_enterprise_monthly')}>\n            Upgrade to Enterprise\n          </button>\n        </div>\n      ) : (\n        <button onClick={handleManage}>Manage Subscription</button>\n      )}\n    </div>\n  );\n}\n```\n\n## 3. Checkout API Route\n\n```typescript\n// app/api/billing/create-checkout/route.ts\nimport { auth, clerkClient } from '@clerk/nextjs/server';\nimport Stripe from 'stripe';\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {\n  apiVersion: '2025-02-24.clover',\n});\n\nexport async function POST(req: Request) {\n  const { userId, orgId } = await auth();\n  if (!userId || !orgId) {\n    return Response.json({ error: 'Unauthorized' }, { status: 401 });\n  }\n\n  const { priceId } = await req.json();\n  const org = await clerkClient.organizations.getOrganization({ organizationId: orgId });\n  \n  let customerId = org.publicMetadata?.stripeCustomerId as string;\n  \n  // Create customer if doesn't exist\n  if (!customerId) {\n    const customer = await stripe.customers.create({\n      metadata: { clerkOrgId: orgId },\n    });\n    customerId = customer.id;\n    await clerkClient.organizations.updateOrganization(orgId, {\n      publicMetadata: { stripeCustomerId: customerId },\n    });\n  }\n\n  const session = await stripe.checkout.sessions.create({\n    customer: customerId,\n    mode: 'subscription',\n    line_items: [{ price: priceId, quantity: 1 }],\n    success_url: `${process.env.NEXT_PUBLIC_URL}/dashboard/billing?success=true`,\n    cancel_url: `${process.env.NEXT_PUBLIC_URL}/dashboard/billing?canceled=true`,\n    metadata: { clerkOrgId: orgId },\n  });\n\n  return Response.json({ url: session.url });\n}\n```\n\n## 4. Webhook Handler\n\n```typescript\n// app/api/webhooks/stripe/route.ts\nimport { clerkClient } from '@clerk/nextjs/server';\nimport Stripe from 'stripe';\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {\n  apiVersion: '2025-02-24.clover',\n});\n\nexport async function POST(req: Request) {\n  const body = await req.text();\n  const sig = req.headers.get('stripe-signature')!;\n  const client = await clerkClient();\n  \n  const event = stripe.webhooks.constructEvent(\n    body,\n    sig,\n    process.env.STRIPE_WEBHOOK_SECRET!\n  );\n\n  if (event.type === 'checkout.session.completed') {\n    const session = event.data.object as Stripe.Checkout.Session;\n    const orgId = session.metadata?.clerkOrgId;\n    \n    if (orgId) {\n      await client.organizations.updateOrganization(orgId, {\n        publicMetadata: {\n          plan: 'pro',\n          stripeSubscriptionId: session.subscription,\n        },\n      });\n    }\n  }\n\n  if (event.type === 'customer.subscription.deleted') {\n    const subscription = event.data.object as Stripe.Subscription;\n    const customer = await stripe.customers.retrieve(subscription.customer as string);\n    const orgId = (customer as Stripe.Customer).metadata?.clerkOrgId;\n    \n    if (orgId) {\n      await client.organizations.updateOrganization(orgId, {\n        publicMetadata: { plan: 'free', stripeSubscriptionId: null },\n      });\n    }\n  }\n\n  return Response.json({ received: true });\n}\n```\n\n---\n\n# OrganizationSwitcher Component\n\nPre-built dropdown for switching between organizations.\n\n```typescript\nimport { OrganizationSwitcher } from '@clerk/clerk-react';\n\nexport function Header() {\n  return (\n    <header>\n      <OrganizationSwitcher \n        // Hide personal workspace (for B2B apps)\n        hidePersonal={true}\n        \n        // Redirect after org selection\n        afterSelectOrganizationUrl=\"/dashboard\"\n        afterCreateOrganizationUrl=\"/onboarding\"\n        afterLeaveOrganizationUrl=\"/select-org\"\n        \n        // Show create organization option\n        createOrganizationMode=\"modal\" // or \"navigation\"\n        createOrganizationUrl=\"/create-org\"\n        \n        // Customize appearance\n        appearance={{\n          elements: {\n            rootBox: 'my-custom-class',\n            organizationSwitcherTrigger: 'border rounded-lg px-4 py-2',\n          },\n        }}\n      />\n    </header>\n  );\n}\n```\n\n## Force Organization Selection\n\nFor B2B apps, ensure users always have an org selected:\n\n```typescript\n// middleware.ts\nimport { clerkMiddleware } from '@clerk/nextjs/server';\n\nexport default clerkMiddleware(async (auth, req) => {\n  const { orgId } = await auth();\n  \n  // Allow org selection page\n  if (req.nextUrl.pathname === '/select-org') {\n    return;\n  }\n  \n  // Redirect to org selection if none active\n  if (req.nextUrl.pathname.startsWith('/dashboard') && !orgId) {\n    return Response.redirect(new URL('/select-org', req.url));\n  }\n});\n```\n\n---\n\n# Protect Component\n\nConditionally render content based on authentication and roles.\n\n```typescript\nimport { Protect } from '@clerk/clerk-react';\n\nexport function AdminDashboard() {\n  return (\n    <div>\n      {/* Only visible to authenticated users */}\n      <Protect>\n        <p>You are signed in!</p>\n      </Protect>\n\n      {/* Only visible to org admins */}\n      <Protect role=\"org:admin\">\n        <button>Delete Organization</button>\n      </Protect>\n\n      {/* Only visible to users with specific permission */}\n      <Protect permission=\"org:billing:manage\">\n        <a href=\"/billing\">Manage Billing</a>\n      </Protect>\n\n      {/* Fallback for unauthorized users */}\n      <Protect\n        role=\"org:admin\"\n        fallback={<p>Only admins can see this section.</p>}\n      >\n        <AdminSettings />\n      </Protect>\n\n      {/* Condition-based protection */}\n      <Protect\n        condition={(has) => has({ role: 'org:admin' }) || has({ role: 'org:billing' })}\n      >\n        <BillingSection />\n      </Protect>\n    </div>\n  );\n}\n```\n\n## Custom Permissions\n\nDefine custom permissions in Clerk Dashboard under **Organizations** ‚Üí **Roles & Permissions**:\n\nExample permissions:\n- `org:billing:manage`\n- `org:members:invite`\n- `org:settings:edit`\n- `org:content:publish`\n\n```typescript\n<Protect permission=\"org:content:publish\">\n  <button>Publish Article</button>\n</Protect>\n```\n\n---\n\n# Server-Side Auth in Next.js 15\n\nAccess auth in Server Components, API routes, and Server Actions.\n\n**Requirements**: Next.js 15+ with App Router\n\n## Server Components\n\n```typescript\n// app/dashboard/page.tsx\nimport { auth, currentUser } from '@clerk/nextjs/server';\n\nexport default async function DashboardPage() {\n  // Get basic auth info\n  const { userId, orgId, orgRole } = await auth();\n  \n  if (!userId) {\n    return <div>Please sign in</div>;\n  }\n\n  // Get full user object when needed\n  const user = await currentUser();\n\n  return (\n    <div>\n      <h1>Welcome, {user?.firstName}!</h1>\n      {orgId && <p>Organization: {orgId}</p>}\n    </div>\n  );\n}\n```\n\n## API Routes\n\n```typescript\n// app/api/data/route.ts\nimport { auth } from '@clerk/nextjs/server';\n\nexport async function GET() {\n  const { userId, orgId } = await auth();\n\n  if (!userId) {\n    return Response.json({ error: 'Unauthorized' }, { status: 401 });\n  }\n\n  // Fetch data scoped to user or organization\n  const data = await db.items.findMany({\n    where: orgId \n      ? { organizationId: orgId }\n      : { userId },\n  });\n\n  return Response.json(data);\n}\n```\n\n## Server Actions\n\n```typescript\n// app/actions.ts\n'use server';\nimport { auth } from '@clerk/nextjs/server';\n\nexport async function createItem(formData: FormData) {\n  const { userId, orgId } = await auth();\n  \n  if (!userId) {\n    throw new Error('Unauthorized');\n  }\n\n  const name = formData.get('name') as string;\n  \n  await db.items.create({\n    data: {\n      name,\n      userId,\n      organizationId: orgId,\n    },\n  });\n}\n```\n\n## Protect Routes in Middleware\n\n```typescript\n// middleware.ts\nimport { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server';\n\nconst isProtectedRoute = createRouteMatcher([\n  '/dashboard(.*)',\n  '/api/private(.*)',\n]);\n\nexport default clerkMiddleware(async (auth, req) => {\n  if (isProtectedRoute(req)) {\n    await auth.protect();\n  }\n});\n\nexport const config = {\n  matcher: ['/((?!.*\\\\..*|_next).*)', '/', '/(api|trpc)(.*)'],\n};\n```\n\n## Get Session Token for External APIs\n\n```typescript\nimport { auth } from '@clerk/nextjs/server';\n\nexport async function GET() {\n  const { getToken } = await auth();\n  \n  // Get token for your backend\n  const token = await getToken();\n  \n  // Get token for specific integration\n  const supabaseToken = await getToken({ template: 'supabase' });\n  \n  // Use token to call external API\n  const response = await fetch('https://api.example.com/data', {\n    headers: { Authorization: `Bearer ${token}` },\n  });\n  \n  return Response.json(await response.json());\n}\n```\n\n---\n\n# Clerk Backend SDK\n\nPerform admin operations like user management from your server.\n\n## Next.js 15\n\n```typescript\nimport { clerkClient } from '@clerk/nextjs/server';\n\nconst client = await clerkClient();\n\n// Get user by ID\nconst user = await client.users.getUser('user_xxx');\n\n// List users\nconst users = await client.users.getUserList({\n  limit: 10,\n  offset: 0,\n  orderBy: '-created_at',\n});\n\n// Update user metadata\nawait client.users.updateUser('user_xxx', {\n  publicMetadata: { role: 'admin' },\n  privateMetadata: { internalId: '12345' },\n});\n\n// Delete user\nawait client.users.deleteUser('user_xxx');\n```\n\n## Organization Management\n\n```typescript\nimport { clerkClient } from '@clerk/nextjs/server';\n\nconst client = await clerkClient();\n\n// Create organization\nconst org = await client.organizations.createOrganization({\n  name: 'Acme Inc',\n  createdBy: 'user_xxx',\n  publicMetadata: { plan: 'enterprise' },\n});\n\n// Add member to organization\nawait client.organizations.createOrganizationMembership({\n  organizationId: 'org_xxx',\n  userId: 'user_xxx',\n  role: 'admin',\n});\n\n// Update organization metadata (for billing, etc.)\nawait client.organizations.updateOrganization('org_xxx', {\n  publicMetadata: {\n    plan: 'pro',\n    stripeCustomerId: 'cus_xxx',\n    stripeSubscriptionId: 'sub_xxx',\n  },\n});\n\n// Remove member\nawait client.organizations.deleteOrganizationMembership({\n  organizationId: 'org_xxx',\n  userId: 'user_xxx',\n});\n```\n\n## Invitations\n\n```typescript\nimport { clerkClient } from '@clerk/nextjs/server';\n\nconst client = await clerkClient();\n\n// Create invitation\nawait client.invitations.createInvitation({\n  emailAddress: 'user@example.com',\n  redirectUrl: 'https://app.example.com/accept-invite',\n  publicMetadata: { referredBy: 'user_xxx' },\n});\n\n// Revoke invitation\nawait client.invitations.revokeInvitation('inv_xxx');\n```\n\n## Webhooks for User Events\n\n```typescript\n// app/api/webhooks/clerk/route.ts\nimport { Webhook } from 'svix';\nimport { headers } from 'next/headers';\nimport { WebhookEvent } from '@clerk/nextjs/server';\n\nexport async function POST(req: Request) {\n  const WEBHOOK_SECRET = process.env.CLERK_WEBHOOK_SECRET!;\n  const headerPayload = await headers();\n  const svix_id = headerPayload.get('svix-id');\n  const svix_timestamp = headerPayload.get('svix-timestamp');\n  const svix_signature = headerPayload.get('svix-signature');\n\n  const payload = await req.json();\n  const body = JSON.stringify(payload);\n\n  const wh = new Webhook(WEBHOOK_SECRET);\n  let evt: WebhookEvent;\n\n  try {\n    evt = wh.verify(body, {\n      'svix-id': svix_id!,\n      'svix-timestamp': svix_timestamp!,\n      'svix-signature': svix_signature!,\n    }) as WebhookEvent;\n  } catch (err) {\n    return Response.json({ error: 'Invalid webhook' }, { status: 400 });\n  }\n\n  switch (evt.type) {\n    case 'user.created':\n      // Sync to database, send welcome email, etc.\n      await db.users.create({\n        data: {\n          clerkId: evt.data.id,\n          email: evt.data.email_addresses[0]?.email_address,\n        },\n      });\n      break;\n      \n    case 'organization.created':\n      // Create org in your database\n      await db.organizations.create({\n        data: {\n          clerkId: evt.data.id,\n          name: evt.data.name,\n        },\n      });\n      break;\n  }\n\n  return Response.json({ received: true });\n}\n```"
    }
  ],
  "transcript": "# MCP Evaluation Transcript\n\n## System Prompt\n\n```\nYOU MUST output all files as fenced code blocks, like so\n\n```lang file=\"path/to/file.ts\"\n\n```\n```\n\n## User Prompt\n\n```markdown\n# Task\n\nBuild a Clerk-enabled Next.js App Router admin area that enforces both authentication and authorization for an organization settings page.\n```\n\n---\n\n## Conversation\n\n### Step 1 (tool-calls)\n\n**Assistant:**\n\nI'll help you build a Clerk-enabled Next.js App Router admin area with authentication and authorization for organization settings. Let me get the relevant code snippets for this implementation.\n\n\n**Tool Calls:**\n\n`clerk_sdk_snippet`\n```json\n{}\n```\n\n**Tool Results:**\n\n`clerk_sdk_snippet` returned:\n```\n# B2B-SAAS Bundle\n\nComplete B2B SaaS setup with organizations, billing, and role-based access\n\nIncludes: use-user, use-auth, use-organization, use-organization-list, b2b-saas-setup, billing-integration, organization-switcher, protect-component, server-auth-nextjs, clerk-client-backend\n\n---\n\n# useUser hook\n\nReturns the current user object and loading/signed-in state.\n\n```typescript\nimport { useUser } from '@clerk/clerk-react';\n\nexport function UserProfile() {\n  const { isLoaded, isSignedIn, user } = useUser();\n\n  if (!isLoaded) {\n    return <div>Loading...</div>;\n  }\n\n  if (!isSignedIn) {\n    return <div>Not signed in</div>;\n  }\n\n  return (\n    <div>\n      <h1>Welcome, {user.firstName}!</h1>\n      <p>Email: {user.primaryEmailAddress?.emailAddress}</p>\n      <img src={user.imageUrl} alt=\"Profile\" />\n    </div>\n  );\n}\n```\n\n## Return Type\n- `isLoaded: boolean` - Whether user data has loaded\n- `isSignedIn: boolean | undefined` - Whether user is signed in (undefined while loading)\n- `user: U...\n\n_(truncated, 24268 chars total)_\n```\n\n---\n\n### Step 2 (length)\n\n**Assistant:**\n\nNow I'll create a comprehensive Clerk-enabled Next.js App Router admin area with authentication and authorization for organization settings. Based on the snippets, I'll build a complete solution:\n\n## 1. Project Setup\n\n```typescript file=\"app/layout.tsx\"\nimport {\n  ClerkProvider,\n  SignedIn,\n  SignedOut,\n  UserButton,\n  OrganizationSwitcher,\n} from '@clerk/nextjs';\n\nexport default function RootLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  return (\n    <ClerkProvider>\n      <html l...\n\n_(truncated, 14009 chars total)_\n\n\n---\n\n## Grader Results\n\n**Score: 20.0%** (2/10)\n\n| Grader | Result |\n|--------|--------|\n| admin_page_file | FAIL |\n| admin_route_handler_file | FAIL |\n| middleware_file_name | PASS |\n| import_auth_helper | PASS |\n| redirect_to_sign_in | FAIL |\n| auth_protect_usage | FAIL |\n| has_permission_check | FAIL |\n| package_json_clerk_version | FAIL |\n| environment_variables | FAIL |\n| authorization_logic | FAIL |\n"
}
